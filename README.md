# QR コード画像解析 \~より鮮明な正解画像をあなたに\~

このプロジェクトは、QR コード画像の鮮明化、デコード、およびデコード結果の評価を自動化するツールである。

---

## はじめに

まず、以下のコマンドを使用して GitHub リポジトリからプロジェクトのファイルをクローンする。

```bash
git clone https://github.com/raimu38/QR.git
cd QR
```

これにより、プロジェクトの全てのファイルがローカル環境にダウンロードされる。

---

## プロジェクト構成

```
.
├── main.py                   # プログラムの実行起点（対話形式）
├── pipeline.py               # パイプラインのコアロジック
├── qr_enhancer.py            # 画像鮮明化のアルゴリズム
├── qr_decode.py              # QRコードのデコード処理
├── evaluate/                 # 評価レポートの出力先
│   ├── evaluate_pdf.py       # シンプルな画像比較PDFを生成
│   ├── overlay_pdf.py        # オーバーレイ画像比較PDFを生成
│   └── analysis_pdf.py       # 詳細な解析レポートPDFを生成
├── qr_tobakosan/             # 元のQRコード画像を配置するディレクトリ
│   └── (例: 1.png, 2.png)
└── qr_raimu/                 # 鮮明化された画像が保存されるディレクトリ
```

---

## 環境構築

1. **ディレクトリの準備**: `qr_tobakosan`ディレクトリを作成して解析したい画像を配置する。

2. **ライブラリのインストール**: `requirements.txt`に以下の内容を記述し、`pip`でインストールする。

   ```
   numpy==2.2.2
   opencv-python-headless==4.12.0.88
   pyzbar==0.1.9
   fpdf2==2.8.4
   matplotlib==3.10.6
   ```

   インストールコマンド: `pip install -r requirements.txt`

3. **`pyzbar`の依存ライブラリ**: `pyzbar`は、QR コードのデコードを行うためのシステムライブラリに依存する。

   - **Linux (Ubuntu/Debian)**: `sudo apt-get install libzbar0`
   - **macOS (Homebrew)**: `brew install zbar`
   - **Windows**: 通常、**`pip`でのインストール時に同梱されるため、別途のインストールは不要である。**

---

## 実行方法

`main.py`を実行することで、対話形式でプログラムを操作できる。

```bash
python3 main.py
```

実行後、以下の選択肢が表示される。

- **1**: QR コード鮮明化パイプラインを実行し、`evaluate.json`に結果を保存する。
- **2**: `evaluate.json`を基に、`evaluate/`ディレクトリ内に 3 種類の PDF レポートを生成する。

---

## 補助スクリプト

**`code.sh`**

このシェルスクリプトは、プロジェクト内のすべての`.py`ファイルの内容を 1 つの`code.txt`ファイルにまとめる。

### 使い方

1. `code.sh`をプロジェクトのルートディレクトリに配置する。
2. 以下のコマンドで実行する。
   `chmod +x code.sh`
   `./code.sh`

---

## QR コードを鮮明化するロジックのアイデア

今回の QR コードの鮮明化には、QR コードの構造を利用した 2 つの主要なアイデアが実装されている。

---

### 1\. ピクセルではなく「モジュール」単位での二値化

通常の二値化は、個々のピクセルの輝度に基づいて白黒を判断する。しかし、画像がぼやけている場合、この方法ではノイズが多く発生し、安定した結果が得られない。

このロジックは、QR コードが「モジュール」と呼ばれる格子状の最小単位で構成されている特性を利用する。

例えば、`module=33`と設定した場合、画像を 33x33 のグリッドに分割する。各セル（モジュール）内のピクセル群の平均輝度を評価し、そのモジュール全体を白か黒に塗りつぶす。

この手法により、個々のピクセルのノイズに左右されることなく、モジュールという論理的な単位で画像を二値化できる。

---

### 2\. 欠損したファインダーパターンの強制補正

QR コードの 3 隅にある「ファインダーパターン」は、スキャナーが位置や向きを特定するために必須の要素である。

画像がひどく劣化している場合、このパターンが破損し、デコードが失敗することがある。

このロジックでは、画像処理でパターンを検出するのではなく、QR コードの仕様からファインダーパターンの**本来あるべき正確な位置と形状**を計算し、その場所に強制的にパターンを描画する。

この補正により、デコーダーは常に正しい位置情報を得られるため、デコード成功率が向上する。

結論として、このロジックは「QR コードの仕様を事前に知っている」という強みを最大限に活かし、通常の画像処理だけでは困難な問題を克服している。

---

## Docker での実行方法

このプロジェクトは Docker コンテナとして実行できる。Docker を使用すると、環境構築の手間が省け、どこでも同じ環境でプログラムを実行できる。windows の場合は WSL 上で Docker 環境を整える必要がある。

### 1\. Docker イメージのビルド

まず、プロジェクトのルートディレクトリで、`docker-compose.yml`ファイルが存在することを確認し、以下のコマンドを実行する。このコマンドは、`Dockerfile`を基に Docker イメージを構築する。

```bash
docker compose build
```

### 2\. Docker コンテナの実行

ビルドが完了したら、以下のコマンドでコンテナを起動する。`docker compose run`に`-it`オプションを付けることで、コンテナ内で対話形式の入力を可能にする。

```bash
docker compose run -it --rm qr_analyzer
```

- `--rm`: コンテナの実行終了時に自動的に削除するオプションである。
- `qr_analyzer`: `docker-compose.yml`で指定されたサービス名である。

このコマンドを実行すると、コンテナが起動し、`main.py`の対話形式のプロンプトが表示されるので、あとは画面の指示に従って操作する。
